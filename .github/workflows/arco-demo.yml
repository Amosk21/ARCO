# .github/workflows/arco-demo.yml
name: ARCO Demo Run

on:
  workflow_dispatch:

jobs:
  arco-demo:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies (explicit for reliability)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # owlrl enables OWL-RL reasoning (critical for entailment)
          pip install rdflib pyshacl owlrl
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run ARCO pipeline (stream logs + capture)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p runs/demo
          python -u 03_TECHNICAL_CORE/scripts/run_pipeline.py | tee runs/demo/demo.log

      - name: Publish result summary (no log-hunting)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "## ARCO Demo Result" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f runs/demo/demo.log ]; then
            if grep -q "ALL CHECKS PASSED" runs/demo/demo.log; then
              echo "**Overall:** PASS" >> "$GITHUB_STEP_SUMMARY"
            elif grep -q "SOME CHECKS FAILED" runs/demo/demo.log; then
              echo "**Overall:** FAIL" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "**Overall:** (unknown, check log)" >> "$GITHUB_STEP_SUMMARY"
            fi

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Key lines" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            grep -E "^(SHACL:|Traceability:|Latent risk:|Entailment:|Entailed triples added:)" runs/demo/demo.log \
              >> "$GITHUB_STEP_SUMMARY" || true

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Artifacts" >> "$GITHUB_STEP_SUMMARY"
            echo "- runs/demo/demo.log" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "**Overall:** (no demo.log found)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload demo artifacts (single obvious download)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: arco-demo-artifacts
          path: runs/demo
          if-no-files-found: error
