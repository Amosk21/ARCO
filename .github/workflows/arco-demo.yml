# .github/workflows/arco-demo.yml
name: ARCO Demo Run

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  arco-demo:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run ARCO pipeline
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p runs/demo
          python -u 03_TECHNICAL_CORE/scripts/run_pipeline.py 2>&1 | tee runs/demo/demo.log

      - name: Assert certificate output
        shell: bash
        run: |
          set -euo pipefail
          if grep -q "REGULATORY DETERMINATION CERTIFICATE" runs/demo/demo.log; then
            echo "Certificate block found in console output."
          else
            echo "FAIL: 'REGULATORY DETERMINATION CERTIFICATE' not found in pipeline output."
            exit 1
          fi

      - name: Verify artifact files exist
        shell: bash
        run: |
          set -euo pipefail
          for f in certificate.txt summary.json evidence.json shacl_report.txt; do
            if [ ! -f "runs/demo/$f" ]; then
              echo "FAIL: runs/demo/$f not found."
              exit 1
            fi
          done
          echo "All artifact files present."

      - name: Publish result summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "## ARCO Demo Result" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f runs/demo/demo.log ]; then
            if grep -q "ALL CHECKS PASSED" runs/demo/demo.log; then
              echo "**Overall:** PASS" >> "$GITHUB_STEP_SUMMARY"
            elif grep -q "SOME CHECKS FAILED" runs/demo/demo.log; then
              echo "**Overall:** FAIL" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "**Overall:** (unknown, check log)" >> "$GITHUB_STEP_SUMMARY"
            fi

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Artifacts" >> "$GITHUB_STEP_SUMMARY"
            for f in runs/demo/*; do
              echo "- \`$(basename $f)\`" >> "$GITHUB_STEP_SUMMARY"
            done
          else
            echo "**Overall:** (no demo.log found)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload demo artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: arco-demo-artifacts
          path: runs/demo/
          if-no-files-found: error
